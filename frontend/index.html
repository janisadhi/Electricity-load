<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Province Map with Power Usage</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        #map {
            height: 600px;
        }
    </style>
</head>
<body>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        // Initialize the map
        const map = L.map('map').setView([28.3949, 84.1240], 7); // Centered in Nepal

        // Set up the tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Function to determine color based on power usage
        function getColor(allocated, current) {
            const usagePercentage = allocated > 0 ? (current / allocated) * 100 : 0;
            if (usagePercentage < 90) {
                return 'green';
            } else if (usagePercentage < 100) {
                return 'yellow';
            } else {
                return 'red';
            }
        }

        // Fetch power data from the API
        fetch('http://127.0.0.1:5000/power-data')
            .then(response => response.json())
            .then(powerData => {
                console.log("Power Data:", powerData); // Debugging

                // Fetch the GeoJSON data from the corrected JSON file
                fetch('nepal-states.json')
                    .then(response => response.json())
                    .then(provincesGeoJSON => {
                        console.log("GeoJSON Data:", provincesGeoJSON); // Debugging

                        L.geoJSON(provincesGeoJSON, {
                            style: function(feature) {
                                // Use 'name' instead of 'id' to match power data
                                const provinceName = feature.properties.name; 
                                const allocatedPower = powerData[provinceName]?.allocated || 0;
                                const currentPower = powerData[provinceName]?.current || 0;

                                return {
                                    fillColor: getColor(allocatedPower, currentPower),
                                    weight: 2,
                                    opacity: 1,
                                    color: 'white',
                                    fillOpacity: 0.7
                                };
                            },
                            onEachFeature: function(feature, layer) {
                                const provinceName = feature.properties.name;
                                const allocatedPower = powerData[provinceName]?.allocated || 0;
                                const currentPower = powerData[provinceName]?.current || 0;

                                layer.bindPopup(`<b>${provinceName}</b><br>Allocated Power: ${allocatedPower} MW<br>Current Power: ${currentPower} MW`);
                            }
                        }).addTo(map);
                    })
                    .catch(error => console.error('Error loading GeoJSON:', error));
            })
            .catch(error => console.error('Error fetching power data:', error));
    </script>

</body>
</html>
