<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Substations Map with Power Usage</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f4f7fc;
            color: #333;
            margin: 0;
            padding: 0;
        }

        h1 {
            text-align: center;
            margin: 20px;
            font-size: 2rem;
            color: #333;
        }

        #map {
            height: 500px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .dashboard {
            display: flex;
            justify-content: space-around;
            margin: 20px;
            gap: 20px;
            flex-wrap: wrap;
        }

        .card {
            background-color: #ffffff;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            width: 30%;
            min-width: 250px;
            text-align: center;
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card h3 {
            font-size: 1.4rem;
            color: #333;
            margin-bottom: 15px;
        }

        .card p {
            font-size: 1.1rem;
            color: #666;
        }

        .card p#overallUsage, .card p#averageUsage {
            font-size: 1.5rem;
            font-weight: bold;
            color: #444;
        }

        #usageChart {
            height: 300px;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .dashboard {
                flex-direction: column;
                align-items: center;
            }

            .card {
                width: 80%;
                margin-bottom: 20px;
            }
        }

    </style>
</head>
<body>

    <h1>Power Usage by substations</h1>

    <div class="dashboard">
        <div class="card">
            <h3>Overall Power Usage</h3>
            <p id="overallUsage">Loading...</p>
        </div>
        <div class="card">
            <h3>Average Power Usage</h3>
            <p id="averageUsage">Loading...</p>
        </div>
        <div class="card">
            <h3>Substations Breakdown</h3>
            <canvas id="usageChart"></canvas>
        </div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        // Initialize the map with locked controls (no zoom or pan)
        const map = L.map('map', {
            center: [28.3949, 84.1240],  // Centered in Nepal
            zoom: 7,
            dragging: false,           // Disable dragging (panning)
            zoomControl: false,        // Disable zoom control buttons
            scrollWheelZoom: false,    // Disable scroll zoom
            doubleClickZoom: false,    // Disable double-click zoom
            boxZoom: false,            // Disable box zoom
            keyboard: false            // Disable keyboard navigation
        });
    
        // Add a plain white background tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        
        // Function to determine color based on power usage
        function getColor(allocated, current) {
            const usagePercentage = allocated > 0 ? (current / allocated) * 100 : 0;
            if (usagePercentage < 90) {
                return '#4CAF50';  // Green
            } else if (usagePercentage < 100) {
                return '#FFEB3B';  // Yellow
            } else {
                return '#F44336';  // Red
            }
        }

        // Fetch power data from the API
        fetch('http://127.0.0.1:5000/power-data')
            .then(response => response.json())
            .then(powerData => {
                console.log("Power Data:", powerData); // Debugging

                // Initialize variables for chart and stats
                let overallUsage = 0;
                let averageUsage = 0;
                let totalsubstations = 0;
                let substationNames = [];
                let substationUsage = [];

                // Fetch the GeoJSON data
                fetch('/static/dash/nepal-states.json')
                    .then(response => response.json())
                    .then(substationsGeoJSON => {
                        console.log("GeoJSON Data:", substationsGeoJSON); // Debugging

                        L.geoJSON(substationsGeoJSON, {
                            style: function(feature) {
                                const substationName = feature.properties.name; 
                                const allocatedPower = powerData[substationName]?.allocated || 0;
                                const currentPower = powerData[substationName]?.current || 0;

                                overallUsage += currentPower;
                                totalsubstations++;

                                averageUsage = overallUsage / totalsubstations;

                                substationNames.push(substationName);
                                substationUsage.push(currentPower);

                                return {
                                    fillColor: getColor(allocatedPower, currentPower),
                                    weight: 2,
                                    opacity: 1,
                                    color: '#fff', // White border
                                    fillOpacity: 0.7
                                };
                            },
                            onEachFeature: function(feature, layer) {
                                const substationName = feature.properties.name;
                                const allocatedPower = powerData[substationName]?.allocated || 0;
                                const currentPower = powerData[substationName]?.current || 0;
    
                                layer.bindPopup(`<b>${substationName}</b><br>Allocated Power: ${allocatedPower} MW<br>Current Power: ${currentPower} MW`);
                            }
                        }).addTo(map);

                        // Update stats
                        document.getElementById('overallUsage').textContent = `${overallUsage} MW`;
                        document.getElementById('averageUsage').textContent = `${averageUsage.toFixed(2)} MW`;

                        // Update the chart
                        new Chart(document.getElementById('usageChart'), {
                            type: 'bar',
                            data: {
                                labels: substationNames,
                                datasets: [{
                                    label: 'Power Usage (MW)',
                                    data: substationUsage,
                                    backgroundColor: 'rgba(0, 123, 255, 0.6)',
                                    borderColor: 'rgba(0, 123, 255, 1)',
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                plugins: {
                                    legend: {
                                        display: false
                                    },
                                    tooltip: {
                                        backgroundColor: '#333',
                                        titleColor: '#fff',
                                        bodyColor: '#fff'
                                    }
                                },
                                scales: {
                                    x: {
                                        ticks: { 
                                            maxRotation: 90, 
                                            minRotation: 45 
                                        }
                                    },
                                    y: {
                                        beginAtZero: true,
                                        grid: {
                                            color: '#ddd'
                                        }
                                    }
                                }
                            }
                        });
                    })
                    .catch(error => console.error('Error loading GeoJSON:', error));
            })
            .catch(error => console.error('Error fetching power data:', error));
    </script>

</body>
</html>
